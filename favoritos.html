<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Favoritos ‚Äì NovaModa</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .container-favorites {
      max-width: 1200px;
      margin: 0 auto;
      padding: 120px 20px 60px;
    }

    .page-header-fav {
      margin-bottom: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .page-title-fav {
      font-size: 2.5rem;
      color: #fff;
      margin: 0;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .fav-count {
      font-size: 1rem;
      color: #888;
      font-weight: 400;
    }

    .clear-all-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid #ff3b30;
      color: #ff3b30;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all .2s;
    }

    .clear-all-btn:hover {
      background: #ff3b30;
      color: #fff;
    }

    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 24px;
    }

    .fav-item {
      background: #111;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all .3s ease;
      border: 1px solid #222;
      position: relative;
    }

    .fav-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(20, 208, 214, 0.3);
      border-color: var(--accent);
    }

    .fav-img-wrapper {
      position: relative;
      width: 100%;
      height: 320px;
      overflow: hidden;
      background: #0b0b0b;
    }

    .fav-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform .5s ease;
    }

    .fav-item:hover img {
      transform: scale(1.08);
    }

    .remove-fav {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255, 59, 48, 0.9);
      color: #fff;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all .2s;
      z-index: 10;
      border: none;
    }

    .remove-fav:hover {
      background: #ff3b30;
      transform: scale(1.1);
    }

    .fav-info {
      padding: 16px;
    }

    .fav-name {
      font-size: 16px;
      color: #fff;
      margin-bottom: 10px;
      font-weight: 600;
      line-height: 1.3;
    }

    .fav-price {
      font-size: 22px;
      color: var(--accent);
      font-weight: 800;
    }

    .empty-favorites {
      text-align: center;
      padding: 80px 20px;
      background: #111;
      border-radius: 12px;
      border: 1px solid #222;
    }

    .empty-fav-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .empty-favorites h2 {
      font-size: 28px;
      margin-bottom: 15px;
      color: #fff;
    }

    .empty-favorites p {
      color: #888;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 80px 20px;
      color: #14d0d6;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <div id="loader"><div class="spinner"></div></div>

  <header class="header">
    <div class="header-container">
      <div class="logo-area" onclick="location.href='index.html'">
        <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" class="logo" alt="NovaModa">
        <span class="brand">NovaModa</span>
      </div>
      
      <div class="right-area">
        <a class="btn entrar-btn" href="login.html">Entrar</a>
        <div class="icons">
          <span class="icon" onclick="location.href='favoritos.html'">‚ù§</span>
          <span class="icon" onclick="location.href='carrinho.html'">üõí<span class="cart-count">0</span></span>
        </div>
      </div>
    </div>
  </header>

  <main class="container-favorites">
    <div class="page-header-fav">
      <div>
        <h1 class="page-title-fav">
          ‚ù§ Meus Favoritos
          <span class="fav-count" id="favCount">0 itens</span>
        </h1>
      </div>
      <button class="clear-all-btn" id="clearAllBtn" style="display:none">Limpar Tudo</button>
    </div>

    <div class="loading" id="loadingState">‚è≥ Carregando favoritos...</div>

    <div class="empty-favorites" id="emptyFavorites" style="display:none">
      <div class="empty-fav-icon">üíî</div>
      <h2>Nenhum favorito ainda</h2>
      <p>Adicione produtos aos favoritos para acompanh√°-los aqui!</p>
      <a href="categorias.html" class="btn primary">Explorar Produtos</a>
    </div>

    <div class="favorites-grid" id="favoritesGrid" style="display:none">
      <!-- Produtos favoritos inseridos via JS -->
    </div>
  </main>

  <script>
    window.API_BASE = window.location.origin + '/Novamoda/api';
  </script>
  
  <script src="js/storage.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <script>
    /**
     * FAVORITOS - 100% BANCO DE DADOS
     */
    
    let favoriteProducts = [];

    // ==========================================
    // CARREGAR FAVORITOS DO BANCO
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarFavoritos();
      
      if (typeof storage !== 'undefined' && storage.updateCartCount) {
        storage.updateCartCount();
      }
    });

    async function carregarFavoritos() {
      const loading = document.getElementById('loadingState');
      const empty = document.getElementById('emptyFavorites');
      const grid = document.getElementById('favoritesGrid');
      const clearBtn = document.getElementById('clearAllBtn');

      loading.style.display = 'block';
      empty.style.display = 'none';
      grid.style.display = 'none';

      // Verificar login
      if (!storage || !storage.isLoggedIn()) {
        loading.style.display = 'none';
        empty.style.display = 'block';
        empty.innerHTML = `
          <div class="empty-fav-icon">üîí</div>
          <h2>Fa√ßa login para ver seus favoritos</h2>
          <p>Entre na sua conta para gerenciar seus produtos favoritos</p>
          <a href="login.html" class="btn primary">Fazer Login</a>
        `;
        return;
      }

      try {
        const user = storage.getUser();
        console.log('üîó Buscando favoritos do usu√°rio:', user.id);

        const response = await fetch(`${API_BASE}/favoritos/listar.php?usuario_id=${user.id}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('üì¶ Favoritos recebidos:', data);

        if (data.success && data.data && data.data.length > 0) {
          // Buscar detalhes dos produtos
          const produtosPromises = data.data.map(fav => 
            fetch(`${API_BASE}/produtos/detalhes.php?id=${fav.produto_id}`)
              .then(r => r.json())
              .then(d => d.success ? d.data : null)
          );

          favoriteProducts = (await Promise.all(produtosPromises)).filter(p => p !== null);
          
          renderizarFavoritos();
          
          loading.style.display = 'none';
          grid.style.display = 'grid';
          clearBtn.style.display = 'block';
        } else {
          loading.style.display = 'none';
          empty.style.display = 'block';
          clearBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar favoritos:', error);
        loading.innerHTML = `
          <div style="text-align:center;color:#ff3b30;">
            <div style="font-size:4rem;margin-bottom:20px;">‚ùå</div>
            <h3>Erro ao carregar favoritos</h3>
            <p style="color:#888;margin:15px 0;">${error.message}</p>
            <button class="btn primary" onclick="location.reload()" style="padding:12px 24px;margin-top:20px;">
              Tentar Novamente
            </button>
          </div>
        `;
      }
    }

    function renderizarFavoritos() {
      const grid = document.getElementById('favoritesGrid');
      const countEl = document.getElementById('favCount');

      countEl.textContent = `${favoriteProducts.length} ${favoriteProducts.length === 1 ? 'item' : 'itens'}`;

      grid.innerHTML = favoriteProducts.map(p => `
        <div class="fav-item">
          <div class="fav-img-wrapper" onclick="location.href='produto.html?id=${p.id}'">
            <img src="${p.imagem_principal}" alt="${p.nome}" loading="lazy" onerror="this.src='https://via.placeholder.com/400x400/14d0d6/000?text=${encodeURIComponent(p.nome)}'">
            <button class="remove-fav" onclick="event.stopPropagation();removeFavorite(${p.id})" title="Remover dos favoritos">
              √ó
            </button>
          </div>
          <div class="fav-info">
            <div class="fav-name">${p.nome}</div>
            <div class="fav-price">R$ ${parseFloat(p.preco).toFixed(2).replace('.',',')}</div>
          </div>
        </div>
      `).join('');
    }

    // ==========================================
    // REMOVER FAVORITO
    // ==========================================
    async function removeFavorite(id) {
      if (!storage || !storage.isLoggedIn()) return;

      try {
        const user = storage.getUser();
        
        const response = await fetch(`${API_BASE}/favoritos/remover.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            usuario_id: user.id,
            produto_id: id
          })
        });

        const data = await response.json();

        if (data.success) {
          await carregarFavoritos();
          
          if (storage.showToast) {
            storage.showToast('Removido dos favoritos', 'info');
          }
        } else {
          if (storage.showToast) {
            storage.showToast(data.message, 'error');
          }
        }
      } catch (error) {
        console.error('Erro ao remover favorito:', error);
        if (storage.showToast) {
          storage.showToast('Erro ao remover favorito', 'error');
        }
      }
    }

    // ==========================================
    // LIMPAR TODOS
    // ==========================================
    document.getElementById('clearAllBtn').addEventListener('click', async () => {
      if (!confirm('Deseja realmente remover todos os favoritos?')) return;

      if (!storage || !storage.isLoggedIn()) return;

      try {
        const user = storage.getUser();
        
        // Remover todos
        const removePromises = favoriteProducts.map(p => 
          fetch(`${API_BASE}/favoritos/remover.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              usuario_id: user.id,
              produto_id: p.id
            })
          })
        );

        await Promise.all(removePromises);
        
        await carregarFavoritos();
        
        if (storage.showToast) {
          storage.showToast('Todos os favoritos foram removidos', 'success');
        }
      } catch (error) {
        console.error('Erro ao limpar favoritos:', error);
        if (storage.showToast) {
          storage.showToast('Erro ao limpar favoritos', 'error');
        }
      }
    });

    // Expor globalmente
    window.removeFavorite = removeFavorite;
  </script>
</body>
</html>